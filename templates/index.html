<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Data Table with Filters</title>
    <!-- Include Bootstrap CSS for better styling -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        /* Custom styles */
        th {
            cursor: pointer;
            position: relative;
        }
        .sort-indicator {
            font-size: 12px;
            margin-left: 5px;
        }
        .sort-indicator {
            position: absolute;
            right: 8px;
        }
        /* Enhance table grid appearance */
        table {
            border: 1px solid #ccc;
            width: 100%;
        }
        th, td {
            border: 1px solid #ccc !important;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
    <script>
        // Auto-submit the form when filters change
        function autoSubmitForm() {
            document.getElementById('filter-form').submit();
        }

        // Function to handle sorting when a column header is clicked
        function sortTable(column) {
            // Get current URL parameters
            const urlParams = new URLSearchParams(window.location.search);

            // Get current sort column and order
            const currentSortColumn = urlParams.get('sort_column');
            const currentSortOrder = urlParams.get('sort_order') || 'desc';

            // Determine new sort order
            let newSortOrder;
            if (currentSortColumn === column) {
                // Toggle sort order
                newSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
            } else {
                // Default to ascending when a new column is clicked
                newSortOrder = 'desc';
            }

            // Update sorting parameters
            urlParams.set('sort_column', column);
            urlParams.set('sort_order', newSortOrder);

            // Preserve existing filter parameters from the form
            const form = document.getElementById('filter-form');
            const formData = new FormData(form);
            for (const [key, value] of formData.entries()) {
                if (key === 'roles') {
                    urlParams.delete('roles'); // Remove existing roles
                    // Get all selected roles
                    const roles = formData.getAll('roles');
                    roles.forEach(role => urlParams.append('roles', role));
                } else {
                    urlParams.set(key, value);
                }
            }

            // Navigate to the new URL
            window.location.search = urlParams.toString();
        }
    </script>
</head>
<body class="container">
    <h1>Data Table with Filters</h1>
    <form method="GET" id="filter-form" class="mb-4">
        <div class="form-group">
            <h3>Roles:</h3>
            {% for role in roles %}
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="roles" value="{{ role }}" {% if role in selected_roles %}checked{% endif %} onchange="autoSubmitForm()">
                    <label class="form-check-label">{{ role }}</label>
                </div>
            {% endfor %}
        </div>

        <div class="form-group">
            <h3>Win Rate:</h3>
            <div class="form-inline">
                <label class="mr-2">
                    Greater than:
                    <input type="number" class="form-control ml-2" step="0.01" name="win_rate_min" value="{{ win_rate_min }}" onchange="autoSubmitForm()">
                </label>
                <label class="mr-2">
                    Less than:
                    <input type="number" class="form-control ml-2" step="0.01" name="win_rate_max" value="{{ win_rate_max }}" onchange="autoSubmitForm()">
                </label>
            </div>
        </div>

        <div class="form-group">
            <h3>Pick Rate:</h3>
            <div class="form-inline">
                <label class="mr-2">
                    Greater than:
                    <input type="number" class="form-control ml-2" step="0.01" name="pick_rate_min" value="{{ pick_rate_min }}" onchange="autoSubmitForm()">
                </label>
                <label class="mr-2">
                    Less than:
                    <input type="number" class="form-control ml-2" step="0.01" name="pick_rate_max" value="{{ pick_rate_max }}" onchange="autoSubmitForm()">
                </label>
            </div>
        </div>
    </form>

    <h2>Filtered Data:</h2>
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                {% for column in columns %}
                    <th onclick="sortTable('{{ column }}')">
                        {{ column }}
                        {% if sort_column == column %}
                            {% if sort_order == 'asc' %}
                                <span class="sort-indicator">&#9650;</span> <!-- Up arrow for ascending -->
                            {% else %}
                                <span class="sort-indicator">&#9660;</span> <!-- Down arrow for descending -->
                            {% endif %}
                        {% endif %}
                    </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in data %}
                <tr>
                    {% for column in columns %}
                        {% if column in ['Pokemon', 'Move 1', 'Move 2'] %}
                            <td>
                                <img
                                    src="{{ url_for('static', filename=row[column]) }}"
                                    alt="{{ column }}"
                                    width="100"
                                >
                            </td>
                        {% else %}
                            <td>{{ row[column] }}</td>
                        {% endif %}
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>
